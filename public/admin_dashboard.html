<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Library Dashboard</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gray-50 flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg">
      <div class="p-6">
        <h1 class="text-2xl font-bold">Library</h1>
      </div>
      <nav class="px-4 space-y-1">
        <!-- Sidebar Navigation Buttons -->
        <button
          data-page="dashboard"
          class="page-btn w-full text-left py-2 px-3 rounded hover:bg-gray-100 bg-gray-100 font-medium"
        >
          Dashboard
        </button>
        <button
          data-page="books"
          class="page-btn w-full text-left py-2 px-3 rounded hover:bg-gray-100"
        >
          Books
        </button>
        <button
          data-page="members"
          class="page-btn w-full text-left py-2 px-3 rounded hover:bg-gray-100"
        >
          Members
        </button>
        <button
          data-page="loans"
          class="page-btn w-full text-left py-2 px-3 rounded hover:bg-gray-100"
        >
          Loans
        </button>
        <button
          data-page="reports"
          class="page-btn w-full text-left py-2 px-3 rounded hover:bg-gray-100"
        >
          Reports
        </button>
        <button
          data-page="settings"
          class="page-btn w-full text-left py-2 px-3 rounded hover:bg-gray-100"
        >
          Settings
        </button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <!-- Books Page -->
      <section id="books" class="page-section hidden">
        <!-- Books Search and Add -->
        <div class="flex justify-between items-center mb-6">
          <input
            id="bookSearch"
            type="text"
            placeholder="Search books..."
            class="border rounded-lg px-4 py-2 w-1/3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <button
            id="addBookBtn"
            class="bg-indigo-600 text-white rounded-lg px-4 py-2 hover:bg-indigo-700"
          >
            Add Book
          </button>
        </div>
        <!-- Books Table -->
        <div class="bg-white rounded-2xl shadow-md p-4 overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr>
                <th class="py-2">ID</th>
                <th class="py-2">Title</th>
                <th class="py-2">ISBN</th>
                <th class="py-2">Year</th>
                <th class="py-2">Publisher</th>
              </tr>
            </thead>
            <tbody id="booksTableBody"></tbody>
          </table>
        </div>
        <!-- Add Book Modal -->
        <div
          id="addBookModal"
          class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
        >
          <div class="bg-white rounded-2xl w-96 p-6">
            <h3 class="text-xl font-semibold mb-4">Add New Book</h3>
            <form id="addBookForm" class="space-y-4">
              <!-- Book Form Fields -->
              <div>
                <label class="block text-sm font-medium mb-1">Title</label>
                <input
                  type="text"
                  name="title"
                  required
                  class="border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">ISBN</label>
                <input
                  type="text"
                  name="isbn"
                  required
                  class="border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1"
                  >Year Published</label
                >
                <input
                  type="number"
                  name="year_published"
                  required
                  class="border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Publisher</label>
                <select
                  id="publisherSelect"
                  name="publisher_id"
                  required
                  class="w-full border px-3 py-2 rounded"
                >
                  <option value="">Loading publishers...</option>
                </select>
              </div>
              <!-- Modal Buttons -->
              <div class="flex justify-end space-x-2">
                <button
                  type="button"
                  id="cancelAddBook"
                  class="px-4 py-2 rounded-lg border hover:bg-gray-100"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700"
                >
                  Add Book
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Members Page -->
      <section id="members" class="page-section hidden">
        <!-- Members Search and Add -->
        <div class="flex justify-between items-center mb-6">
          <input
            id="memberSearch"
            type="text"
            placeholder="Search members..."
            class="border rounded-lg px-4 py-2 w-1/3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <button
            id="addMemberBtn"
            class="bg-indigo-600 text-white rounded-lg px-4 py-2 hover:bg-indigo-700"
          >
            Add Member
          </button>
        </div>
        <!-- Members Table -->
        <div class="bg-white rounded-2xl shadow-md p-4 overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr>
                <th class="py-2">Member ID</th>
                <th class="py-2">User ID</th>
                <th class="py-2">Start Date</th>
                <th class="py-2">End Date</th>
                <th class="py-2">Current Loans</th>
                <th class="py-2">Can Borrow</th>
                <th class="py-2">Member Type</th>
              </tr>
            </thead>
            <tbody id="membersTableBody"></tbody>
          </table>
        </div>
        <!-- Add Member Modal -->
        <div
          id="addMemberModal"
          class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
        >
          <div class="bg-white rounded-2xl w-96 p-6">
            <h3 class="text-xl font-semibold mb-4">Add New Member</h3>
            <form id="addMemberForm" class="space-y-4">
              <!-- Member Form Fields -->
              <div>
                <label class="block text-sm font-medium mb-1">User ID</label>
                <input
                  type="number"
                  name="user_id"
                  required
                  class="border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Start Date</label>
                <input
                  type="date"
                  name="membership_start_date"
                  required
                  class="border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">End Date</label>
                <input
                  type="date"
                  name="membership_end_date"
                  required
                  class="border rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1"
                  >Member Type</label
                >
                <select
                  name="member_type"
                  required
                  class="w-full border px-3 py-2 rounded"
                >
                  <option value="">Select Type</option>
                  <option value="Student">Student</option>
                  <option value="Faculty">Faculty</option>
                </select>
              </div>
              <!-- Modal Buttons -->
              <div class="flex justify-end space-x-2">
                <button
                  type="button"
                  id="cancelAddMember"
                  class="px-4 py-2 rounded-lg border hover:bg-gray-100"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700"
                >
                  Add Member
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Loans Page -->
      <section id="loans" class="page-section hidden">
        <div class="flex justify-between items-center mb-6">
          <input
            id="loanSearch"
            type="text"
            placeholder="Search loans..."
            class="border rounded-lg px-4 py-2 w-1/3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <button
            id="addLoanBtn"
            class="bg-indigo-600 text-white rounded-lg px-4 py-2 hover:bg-indigo-700"
          >
            Add Loan
          </button>
        </div>
        <div class="bg-white rounded-2xl shadow-md p-4 overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr>
                <th class="py-2">Loan ID</th>
                <th class="py-2">Member ID</th>
                <th class="py-2">Book ID</th>
                <th class="py-2">Loan Date</th>
                <th class="py-2">Due Date</th>
                <th class="py-2">Return Date</th>
                <th class="py-2">Fine</th>
              </tr>
            </thead>
            <tbody id="loansTableBody"></tbody>
          </table>
        </div>

        <!-- Add Loan Modal -->
        <div
          id="addLoanModal"
          class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
        >
          <div class="bg-white rounded-2xl w-96 p-6">
            <h3 class="text-xl font-semibold mb-4">Add New Loan</h3>
            <form id="addLoanForm" class="space-y-4">
              <div>
                <label class="block text-sm mb-1">Member ID</label>
                <input
                  type="number"
                  name="member_id"
                  required
                  class="border rounded-lg px-3 py-2 w-full"
                />
              </div>
              <div>
                <label class="block text-sm mb-1">Book ID</label>
                <input
                  type="number"
                  name="book_id"
                  required
                  class="border rounded-lg px-3 py-2 w-full"
                />
              </div>
              <div>
                <label class="block text-sm mb-1">Loan Date</label>
                <input
                  type="date"
                  name="loan_date"
                  required
                  class="border rounded-lg px-3 py-2 w-full"
                />
              </div>
              <div>
                <label class="block text-sm mb-1">Due Date</label>
                <input
                  type="date"
                  name="due_date"
                  required
                  class="border rounded-lg px-3 py-2 w-full"
                />
              </div>
              <div>
                <label class="block text-sm mb-1">Return Date</label>
                <input
                  type="date"
                  name="return_date"
                  class="border rounded-lg px-3 py-2 w-full"
                />
              </div>
              <div>
                <label class="block text-sm mb-1">Fine</label>
                <input
                  type="number"
                  name="fine"
                  value="0"
                  min="0"
                  class="border rounded-lg px-3 py-2 w-full"
                />
              </div>
              <div class="flex justify-end space-x-2">
                <button
                  type="button"
                  id="cancelAddLoan"
                  class="px-4 py-2 rounded-lg border hover:bg-gray-100"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700"
                >
                  Add Loan
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <!-- JavaScript -->
    <script>
      // Sidebar Navigation
      document.querySelectorAll(".page-btn").forEach((btn) =>
      btn.addEventListener("click", () => {
        document
        .querySelectorAll(".page-btn")
        .forEach((b) => b.classList.remove("bg-gray-100", "font-medium"));
        btn.classList.add("bg-gray-100", "font-medium");
        document
        .querySelectorAll(".page-section")
        .forEach((sec) => sec.classList.add("hidden"));
        document
        .getElementById(btn.getAttribute("data-page"))
        .classList.remove("hidden");
      })
      );

      // Fetch and Render Data
      async function fetchAll() {
      const res = await fetch("/api/books");
      const data = await res.json();
      renderRows(data, "booksTableBody", renderBookRow);
      }

      async function fetchMembers() {
      const res = await fetch("/api/members");
      const data = await res.json();
      renderRows(data, "membersTableBody", renderMemberRow);
      }

      async function fetchLoans() {
      const res = await fetch("/api/loans");
      const data = await res.json();
      renderRows(data, "loansTableBody", renderLoanRow);
      }

      // Render Rows
      function renderRows(rows, tableBodyId, renderRowFn) {
      const tbody = document.getElementById(tableBodyId);
      tbody.innerHTML = "";
      rows.forEach((row) => tbody.appendChild(renderRowFn(row)));
      }

      function renderBookRow(row) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-2">${row.BOOK_ID}</td>
        <td class="py-2">${row.TITLE}</td>
        <td class="py-2">${row.ISBN}</td>
        <td class="py-2">${row.YEAR_PUBLISHED}</td>
        <td class="py-2">${row.PUBLISHER_ID}</td>
      `;
      return tr;
      }

      function renderMemberRow(row) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-2">${row.MEMBER_ID}</td>
        <td class="py-2">${row.USER_ID}</td>
        <td class="py-2">${row.MEMBERSHIP_START_DATE}</td>
        <td class="py-2">${row.MEMBERSHIP_END_DATE}</td>
        <td class="py-2">${row.CURRENT_LOAN_COUNT}</td>
        <td class="py-2">${row.CAN_BORROW ? "Yes" : "No"}</td>
        <td class="py-2">${row.MEMBER_TYPE}</td>
      `;
      return tr;
      }

      function renderLoanRow(row) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-2">${row.LOAN_ID}</td>
        <td class="py-2">${row.MEMBER_ID}</td>
        <td class="py-2">${row.BOOK_ID}</td>
        <td class="py-2">${row.LOAN_DATE}</td>
        <td class="py-2">${row.DUE_DATE}</td>
        <td class="py-2">${row.RETURN_DATE || ""}</td>
        <td class="py-2">${row.FINE}</td>
      `;
      return tr;
      }

      // Modal Event Listeners
      function setupModalHandlers() {
      setupModal("addBookBtn", "addBookModal", "cancelAddBook");
      setupModal("addMemberBtn", "addMemberModal", "cancelAddMember");
      setupModal("addLoanBtn", "addLoanModal", "cancelAddLoan");
      }

      function setupModal(openBtnId, modalId, closeBtnId) {
      document.getElementById(openBtnId).addEventListener("click", () => {
        document.getElementById(modalId).classList.remove("hidden");
      });
      document.getElementById(closeBtnId).addEventListener("click", () => {
        document.getElementById(modalId).classList.add("hidden");
      });
      }

      // Add Loan Form Submission
      document
      .getElementById("addLoanForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = Object.fromEntries(new FormData(e.target));
        const res = await fetch("/api/loans", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        });
        if (res.ok) {
        e.target.reset();
        document.getElementById("addLoanModal").classList.add("hidden");
        fetchLoans();
        } else {
        console.error("Loan add failed:", await res.text());
        }
      });

      // Initialize Data on Page Load
      document.addEventListener("DOMContentLoaded", () => {
      fetchAll();
      fetchMembers();
      fetchLoans();
      setupModalHandlers();
      });
    </script>
  </body>
</html>
